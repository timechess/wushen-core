# 公式变量文档

本文档列出了词条效果公式系统中所有可用的变量。

## 使用说明

在词条效果的 JSON 配置中，`value` 字段可以是：
- **固定值**：数字，如 `100` 或 `0.5`
- **公式字符串**：数学表达式，如 `"self_z * 2"` 或 `"self_hp / self_max_hp * 100"`

公式支持标准的数学运算符：`+`, `-`, `*`, `/`, `%`, `^`（幂），以及常用数学函数（由 `meval` 库提供）。

## 变量分类

### 一、自身角色面板变量（修行时和战斗时都可用）

所有自身面板变量都以 `self_` 开头。

#### 基本三维属性

| 变量名 | 别名 | 类型 | 说明 | 示例值 |
|--------|------|------|------|--------|
| `self_x` | `self_comprehension` | f64 | 悟性值 | 10.0 |
| `self_y` | `self_bone_structure` | f64 | 根骨值 | 20.0 |
| `self_z` | `self_physique` | f64 | 体魄值 | 30.0 |
| `self_a` | `self_martial_arts_attainment` | f64 | 武学素养 | 50.0 |

**注意**：`self_x` 和 `self_comprehension` 是同一个值，`self_y` 和 `self_bone_structure` 是同一个值，以此类推。

#### 生命值和内息量

| 变量名 | 类型 | 说明 | 初始值 |
|--------|------|------|--------|
| `self_max_hp` | f64 | 生命值上限 | 100 * z |
| `self_hp` | f64 | 当前生命值 | 100 * z |
| `self_max_qi` | f64 | 内息量上限 | 通过修行获取 |
| `self_qi` | f64 | 当前内息量 | 通过修行获取 |

#### 基础战斗属性

| 变量名 | 类型 | 说明 | 初始值 |
|--------|------|------|--------|
| `self_base_attack` | f64 | 基础攻击力 | 3 * z |
| `self_base_defense` | f64 | 基础防御力 | 2 * z |
| `self_max_qi_output_rate` | f64 | 最大内息输出（百分比，小数形式） | 0.3 * y / 100 |
| `self_qi_output_rate` | f64 | 内息输出（百分比，小数形式） | 0.0 |

#### 增伤和减伤

| 变量名 | 类型 | 说明 | 初始值 |
|--------|------|------|--------|
| `self_damage_bonus` | f64 | 增伤（百分比，小数形式） | 0.0 |
| `self_damage_reduction` | f64 | 减伤（百分比，小数形式） | 0.0 |
| `self_max_damage_reduction` | f64 | 减伤上限（百分比，小数形式） | 0.5 (50%) |

#### 武技相关属性

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `self_power` | f64 | 威能（攻击武技属性） |
| `self_defense_power` | f64 | 守御（防御武技属性） |
| `self_qi_quality` | f64 | 内息质量（内功属性） |
| `self_attack_speed` | f64 | 出手速度（内功属性） |
| `self_qi_recovery_rate` | f64 | 回气量（内功属性，百分比，小数形式） |
| `self_charge_time` | f64 | 蓄力时间（攻击武技属性） |

### 二、对方角色面板变量（仅战斗时可用）

所有对方面板变量都以 `opponent_` 开头，变量名与自身面板变量对应。

#### 基本三维属性

| 变量名 | 别名 | 类型 | 说明 |
|--------|------|------|------|
| `opponent_x` | `opponent_comprehension` | f64 | 对手悟性值 |
| `opponent_y` | `opponent_bone_structure` | f64 | 对手根骨值 |
| `opponent_z` | `opponent_physique` | f64 | 对手体魄值 |
| `opponent_a` | `opponent_martial_arts_attainment` | f64 | 对手武学素养 |

#### 生命值和内息量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `opponent_max_hp` | f64 | 对手生命值上限 |
| `opponent_hp` | f64 | 对手当前生命值 |
| `opponent_max_qi` | f64 | 对手内息量上限 |
| `opponent_qi` | f64 | 对手当前内息量 |

#### 基础战斗属性

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `opponent_base_attack` | f64 | 对手基础攻击力 |
| `opponent_base_defense` | f64 | 对手基础防御力 |
| `opponent_max_qi_output_rate` | f64 | 对手最大内息输出 |
| `opponent_qi_output_rate` | f64 | 对手内息输出 |

#### 增伤和减伤

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `opponent_damage_bonus` | f64 | 对手增伤 |
| `opponent_damage_reduction` | f64 | 对手减伤 |
| `opponent_max_damage_reduction` | f64 | 对手减伤上限 |

#### 武技相关属性

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `opponent_power` | f64 | 对手威能 |
| `opponent_defense_power` | f64 | 对手守御 |
| `opponent_qi_quality` | f64 | 对手内息质量 |
| `opponent_attack_speed` | f64 | 对手出手速度 |
| `opponent_qi_recovery_rate` | f64 | 对手回气量 |
| `opponent_charge_time` | f64 | 对手蓄力时间 |

### 三、攻击结果变量（仅攻击后/防御后可用）

这些变量仅在以下触发时机可用：
- `after_attack`（攻击后）
- `after_defense`（防御后）

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `attack_total_output` | f64 | 总输出（攻击者的总攻击力） |
| `attack_total_defense` | f64 | 总防御力（防御者的总防御力） |
| `attack_reduced_output` | f64 | 减伤后输出（应用减伤后的输出） |
| `attack_hp_damage` | f64 | 生命值伤害（实际造成的生命值伤害） |
| `attack_attacker_qi_consumed` | f64 | 攻击者内息消耗 |
| `attack_defender_qi_consumed` | f64 | 防御者内息消耗 |
| `attack_broke_qi_defense` | f64 | 是否击破内息防御（1.0 = 是，0.0 = 否） |

## 使用示例

### 示例 1：基于体魄增加攻击力

```json
{
  "type": "modify_attribute",
  "target": "base_attack",
  "value": "self_z * 2",
  "operation": "add"
}
```

### 示例 2：基于生命值百分比增加防御力

```json
{
  "type": "modify_attribute",
  "target": "base_defense",
  "value": "self_hp / self_max_hp * 100",
  "operation": "add"
}
```

### 示例 3：基于对手属性计算效果（战斗时）

```json
{
  "type": "modify_attribute",
  "target": "damage_bonus",
  "value": "opponent_hp / opponent_max_hp * 0.5",
  "operation": "add"
}
```

### 示例 4：基于攻击结果计算效果（攻击后）

```json
{
  "type": "modify_attribute",
  "target": "hp",
  "value": "attack_hp_damage * 0.1",
  "operation": "add"
}
```

### 示例 5：条件判断（使用攻击结果）

```json
{
  "type": "modify_attribute",
  "target": "damage_bonus",
  "value": "attack_broke_qi_defense * 0.2",
  "operation": "add"
}
```

### 示例 6：复杂公式

```json
{
  "type": "modify_attribute",
  "target": "base_attack",
  "value": "(self_z + self_a) * 1.5 + self_qi * 0.1",
  "operation": "add"
}
```

## 注意事项

1. **变量可用性**：
   - 修行时：只能使用 `self_*` 变量
   - 战斗时：可以使用 `self_*` 和 `opponent_*` 变量
   - 攻击后/防御后：可以使用所有变量，包括 `attack_*` 变量

2. **变量类型**：
   - 所有变量都是 `f64`（浮点数）类型
   - 百分比值以小数形式存储（如 0.5 表示 50%）

3. **公式错误处理**：
   - 如果公式解析或计算失败，该效果会被跳过，不会影响其他效果
   - 错误信息会输出到标准错误流（stderr）

4. **性能考虑**：
   - 公式在每次触发时都会重新计算
   - 复杂的公式可能会影响性能，建议使用简单的表达式

5. **数学函数**：
   - 公式支持 `meval` 库提供的所有数学函数
   - 常用函数包括：`sin`, `cos`, `tan`, `sqrt`, `abs`, `max`, `min`, `floor`, `ceil`, `round` 等

## 相关文档

- [角色系统.md](./角色系统.md) - 角色面板的详细说明
- [战斗系统.md](./战斗系统.md) - 战斗系统的详细说明
